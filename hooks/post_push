#!/bin/bash

DPWD=$(pwd)

# Listing some useful commands
echo "CI: $CI"
echo "DOCKER_REPO: $DOCKER_REPO"
echo "SOURCE_BRANCH: $SOURCE_BRANCH"
echo

# Make sure only tagged commits triggers logic in hooks files.
if [ "$SOURCE_BRANCH" = "master" ]; then
    exit
fi

function tag {
  echo "Tag:   $1 => $(real $2)"
  docker tag $DOCKER_REPO:$1 $DOCKER_REPO:$(real $2)
  push $2
}

function build {
  build_only $1 $2
  echo -n "       Verification: "
  docker run --rm $DOCKER_REPO:$1 version
  push $1

  for t in ${@:3}; do
    tag $1 "$t"
  done
}

function build_only {
  name=$2
  if [ "$2" = "" ] || [ "$2" = "-" ]; then
    if [ -e "Dockerfile-gen-$1" ]; then
      name="gen-$1"
    else
      name=$1
    fi
  fi

  echo "Build: $1 (Dockerfile-$name)"
  docker build -t $DOCKER_REPO:$1 -f Dockerfile-$name . > /dev/null
}

function push {
  img=$DOCKER_REPO:$(real $1)
  if [ "$CI" != "true" ]; then
    echo "       Push: $img"
    docker push $img > /dev/null
  else
    if [ "$DEBUG" = "true" ]; then
      echo "       Push: $img (skipped)"
    fi
  fi
}

function real {
  echo $1 | sed -e "s/\[version\]/${SOURCE_BRANCH}/g"
}

# template [tp] [target] [from]
function template {
  cat $DPWD/lib/template/Dockerfile-$1 | sed -e "s|\[from\]|${DOCKER_REPO}:${3}|g" > Dockerfile-gen-$2
}

function trigger {
  # Go to folder
  cd $DPWD/$1

  # Trigger configuration
  source config
  echo
}

# Build base images if found
if [ -e lib/base ]; then trigger "lib/base"; fi

# Build distributions provided
for VARIANT in $(ls $DPWD/dist); do
  trigger "dist/$VARIANT"
done
